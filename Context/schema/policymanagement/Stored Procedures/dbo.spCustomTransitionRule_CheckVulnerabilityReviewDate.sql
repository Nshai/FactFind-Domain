SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO 

/*
Modification History (most recent first)
Date        Modifier        Issue          Description
----        ---------       -------        -------------
20230201    Arun Sivan      SE-3353        Created SP to check the Vulnerability Review Date is blank or past date
*/
CREATE PROCEDURE [dbo].[spCustomTransitionRule_CheckVulnerabilityReviewDate]    
  @PolicyBusinessId INT,    
  @ErrorMessage VARCHAR(512) OUTPUT    
AS    

	DECLARE @ClientCount TINYINT
	DECLARE @ClientType VARCHAR(10)
	DECLARE @Owner1Id INT 
	DECLARE @Owner2Id INT 
	DECLARE @Owner1Name VARCHAR(255) 
	DECLARE @Owner2Name VARCHAR(255)  

	EXEC spCustomTansitionRuleGetOwners @PolicyBusinessId, 
										@ClientCount OUTPUT, @ClientType OUTPUT,
										@Owner1Id OUTPUT, @Owner1Name OUTPUT, 
										@Owner2Id OUTPUT, @Owner2Name OUTPUT
										
	--Only applies to person clients
	IF @ClientType != 'PERSON'
		RETURN(0)	
	
	DECLARE @Valid1 INT = 0
	DECLARE @Valid2 INT = 0

	SET @Valid1 = 
		(
			SELECT COUNT(1) FROM CRM..TCRMContact A
			INNER JOIN CRM..TClientVulnerability B ON A.CRMContactId = B.CRMContactId
			WHERE A.CRMContactId = @Owner1Id
			AND B.IsCurrent = 1
			AND (B.ReviewOn IS NULL OR CAST(ReviewOn AS DATE)< CAST(GETDATE() AS DATE))
		)

	IF(@Owner2Id IS NOT NULL)
	BEGIN

		SET @Valid2 = 
		(
			SELECT COUNT(1) FROM CRM..TCRMContact A
			INNER JOIN CRM..TClientVulnerability B ON A.CRMContactId = B.CRMContactId
			WHERE A.CRMContactId = @Owner2Id
			AND B.IsCurrent = 1
			AND (B.ReviewOn IS NULL OR CAST(ReviewOn AS DATE)< CAST(GETDATE() AS DATE))			
		)
		--if Owner2 is not a Person , then ignore
		IF (@Valid2 = 1)
		BEGIN
			SET @Valid2 = (SELECT COUNT(1) FROM CRM..TCRMContact WHERE CRMContactId = @Owner2Id AND (PersonId IS NOT NULL))
		END
	END 

	IF (@Valid1 = 1)
		SELECT @ErrorMessage = 'OWNER1'
	IF (@Valid2 = 1 and @Owner2Id is not null and @Valid1 = 0)
		SELECT @ErrorMessage = 'OWNER2'
	IF (@Valid2 = 1 and @Owner2Id is not null and @Valid1 = 1)
		SELECT @ErrorMessage = 'OWNER1+OWNER2'

	IF(LEN(ISNULL(@ErrorMessage, '')) > 0)
	BEGIN		
		SET @ErrorMessage = @ErrorMessage + '_::Owner1Id=' + CONVERT(varchar(50), ISNULL(@Owner1Id,''))
										  + '::Owner1Name=' + CONVERT(varchar(255), ISNULL(@Owner1Name,''))
										  + '::Owner2Id=' + CONVERT(varchar(50), ISNULL(@Owner2Id,''))
										  + '::Owner2Name=' + CONVERT(varchar(255), ISNULL(@Owner2Name,''))

	END	
GO