SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO


CREATE OR ALTER procedure [dbo].[spCustomTransitionRule_CheckClientVulnerability]
  @PolicyBusinessId bigint,
  @ErrorMessage varchar(1024) output
AS

BEGIN

	DECLARE @Owners TABLE (OwnerNumber int IDENTITY(1,1) PRIMARY KEY, PersonId int,
							CRMContactId bigint, Name varchar(255))
    
	DECLARE @OwnersWithVulnerabilitiesSet TABLE (CRMContactId bigint)

	-- get policy owners
	INSERT INTO @Owners (PersonId, CRMContactId, Name)
	SELECT	 
		ISNULL(con.PersonId, 0),
		po.CRMContactId,
		ISNULL(con.FirstName,'') + ' ' + ISNULL(con.LastName, '')
	FROM	 TPolicyOwner po
	INNER JOIN	 TPolicyDetail pd ON pd.PolicyDetailId = po.PolicyDetailId
	INNER JOIN	 TPolicyBusiness pb ON pb.PolicyDetailId = pd.PolicyDetailId
	INNER JOIN CRM..TCRMContact con on po.CRMContactId = con.CRMContactId
	WHERE	 pb.PolicyBusinessId = @PolicyBusinessId
	ORDER BY po.PolicyOwnerId
	
	INSERT INTO @Owners (PersonId, CRMContactId, Name)
	SELECT	 
		ISNULL(con.PersonId, 0),
		ao.CRMContactId,
		ISNULL(con.FirstName,'') + ' ' + ISNULL(con.LastName, '')
	FROM TAdditionalOwner ao
	INNER JOIN CRM..TCRMContact con on ao.CRMContactId = con.CRMContactId
	WHERE	 ao.PolicyBusinessId = @PolicyBusinessId
	ORDER BY ao.AdditionalOwnerId
			 

	
	Declare @Owner1Id Bigint 
	Declare @Owner2Id Bigint 
	Declare @Owner1Name Varchar(255) 
	Declare @Owner2Name Varchar(255)  
	Declare @Owner3Id Bigint 
	Declare @Owner4Id Bigint 
	Declare @Owner3Name Varchar(255) 
	Declare @Owner4Name Varchar(255)  

	SELECT @Owner1Id = CRMContactId, @Owner1Name = [Name]	FROM @Owners A WHERE PersonId > 0 AND OwnerNumber = 1	
	SELECT @Owner2Id = CRMContactId, @Owner2Name = [Name] FROM @Owners A WHERE PersonId > 0 AND OwnerNumber = 2
	SELECT @Owner3Id = CRMContactId, @Owner3Name = [Name]	FROM @Owners A WHERE PersonId > 0 AND OwnerNumber = 3	
	SELECT @Owner4Id = CRMContactId, @Owner4Name = [Name] FROM @Owners A WHERE PersonId > 0 AND OwnerNumber = 4

	--todo Remove
	--SELECT * FROM @Owners
	--SELECT @Owner1Id, @Owner2Id, @Owner3Id, @Owner4Id
	
	DECLARE @IsVulnerabilitySetOwner1 int = null,
	@IsVulnerabilitySetOwner2 int = null,
	@IsVulnerabilitySetOwner3 int = null,
	@IsVulnerabilitySetOwner4 int = null

	INSERT INTO @OwnersWithVulnerabilitiesSet
	SELECT o.CRMContactId
	FROM @Owners o
		INNER JOIN CRM..TClientVulnerability vul on o.CRMContactId = vul.CRMContactId
	WHERE vul.IsCurrent = 1

	if @Owner1Id is not null
	begin
	set @IsVulnerabilitySetOwner1 = 
		(
			select count(CRMContactId)
			FROM @OwnersWithVulnerabilitiesSet
			WHERE CRMContactId = @Owner1Id
		)
	end

	if @Owner2Id is not null
	begin
		set @IsVulnerabilitySetOwner2 = 
		(
			select count(CRMContactId)
			FROM @OwnersWithVulnerabilitiesSet
			WHERE CRMContactId = @Owner2Id
		)
		
	end

	if @Owner3Id is not null
	begin
		set @IsVulnerabilitySetOwner3 = 
		(
			select count(CRMContactId)
			FROM @OwnersWithVulnerabilitiesSet
			WHERE CRMContactId = @Owner3Id
		)
		
	end

	if @Owner4Id is not null
	begin
		set @IsVulnerabilitySetOwner4 = 
		(
			select count(CRMContactId)
			FROM @OwnersWithVulnerabilitiesSet
			WHERE CRMContactId = @Owner4Id
		)
		
	end


	set @ErrorMessage = ''
	if (@IsVulnerabilitySetOwner1 = 0)
		select @ErrorMessage = 'OWNER1'

	if (@IsVulnerabilitySetOwner2 = 0)
		select @ErrorMessage = IIF(@ErrorMessage = '', @ErrorMessage + 'OWNER2', @ErrorMessage +'+OWNER2')

	if (@IsVulnerabilitySetOwner3 = 0)
		select @ErrorMessage = IIF(@ErrorMessage = '', @ErrorMessage + 'OWNER3', @ErrorMessage + '+OWNER3')

	if (@IsVulnerabilitySetOwner4 = 0)
		select @ErrorMessage = IIF(@ErrorMessage = '', @ErrorMessage + 'OWNER4', @ErrorMessage + '+OWNER4')

	
	Declare @OwnerId bigint
	
	--Add Owner Data for side bar link generator
	IF(LEN(@ErrorMessage) > 0)
	BEGIN		
		SET @ErrorMessage = @ErrorMessage + '_::Owner1Id=' + CONVERT(varchar(50), ISNULL(@Owner1Id,''))
										  + '::Owner1Name=' + CONVERT(varchar(255), ISNULL(@Owner1Name,''))
										  + '::Owner2Id=' + CONVERT(varchar(50), ISNULL(@Owner2Id,''))
										  + '::Owner2Name=' + CONVERT(varchar(255), ISNULL(@Owner2Name,''))
										  + '::Owner3Id=' + CONVERT(varchar(50), ISNULL(@Owner3Id,''))
										  + '::Owner3Name=' + CONVERT(varchar(255), ISNULL(@Owner3Name,''))
										  + '::Owner4Id=' + CONVERT(varchar(50), ISNULL(@Owner4Id,''))
										  + '::Owner4Name=' + CONVERT(varchar(255), ISNULL(@Owner4Name,''))


		
	END			
		
END


GO
